  <source>
      @type tail
      path /var/log/nginx/access*.log
      exclude_path ["/var/log/nginx/*.gz"]
      format grok
      grok_pattern %{NGINX_ACCESS}
      custom_pattern_path /fluentd/grok
      tag nginx.access
      types status:integer,body_bytes_sent:integer,bytes_sent:integer,upstream_addr:array,upstream_status:array,upstream_connect_time:array,upstream_response_length:array,upstream_response_time:array,upstream_header_time:array
  </source>

  <source>
    @type prometheus_monitor
    <labels>
      host ${hostname}
    </labels>
  </source>

  <source>
    @type prometheus
  </source>

  <filter nginx.**>
   @type record_transformer
   enable_ruby
   auto_typecast true
   <record>
    agent ${agent.gsub!(/^\"|\"?$/, '')}
    upstream_addr ${upstream_addr.gsub!(/[^0-9A-Za-z,.:]/, ''); upstream_addr.split(",")}
    upstream_status ${upstream_status.gsub!(/[^0-9A-Za-z,.:]/, ''); upstream_status.split(",")}
    upstream_connect_time ${upstream_connect_time.gsub!(/[^0-9A-Za-z,.:]/, ''); upstream_connect_time.split(",")}
    upstream_response_length ${upstream_response_length.gsub!(/[^0-9A-Za-z,.:]/, ''); upstream_response_length.split(",")}
    upstream_response_time ${upstream_response_time.gsub!(/[^0-9A-Za-z,.:]/, ''); upstream_response_time.split(",")}
    upstream_header_time ${upstream_header_time.gsub!(/[^0-9A-Za-z,.:]/, ''); upstream_header_time.split(",")}
   </record>
  </filter>

  <match nginx.**>
    @type copy
    <store>
      @type elasticsearch
      logstash_format true
      host elasticsearch
      buffer_type memory
      flush_interval 1
    </store>
    <store>
      type prometheus
      <metric>
        name api_http_requests_total
        type counter
        desc The total number of http requests
      </metric>
    </store>
    <store>
      type grep
      regexp1 status ^5\d\d$
      add_tag_prefix error
    </store>
  </match>

  <match error.**>
    @type copy
    <store>
      type prometheus
      <metric>
        name api_http_error_requests_total
        type counter
        desc The total number of http request errors
        <labels>
          upstream_addr ${upstream_addr[-1]}
          http_method ${http_method}
          nginx_version ${nginx_version}
          agent ${agent}
          status ${status}
        </labels>
      </metric>
      <labels>
        tag ${tag}
      </labels>
    </store>
  </match>
