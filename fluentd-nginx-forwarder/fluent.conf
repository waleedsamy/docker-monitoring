<source>
  @type tail
  path /var/log/nginx/access*.log
  exclude_path ["/var/log/nginx/*.gz"]
  pos_file /var/log/td-agent/nginx-access.log.pos
  format grok
  grok_pattern %{NGINX_ACCESS}
  custom_pattern_path /fluentd/grok
  types status:integer,body_bytes_sent:integer,bytes_sent:integer,upstream_addr:array,upstream_status:array,upstream_connect_time:array,upstream_response_length:array,upstream_response_time:array,upstream_header_time:array
  tag nginx.access
</source>

<filter nginx.**>
 @type record_transformer
 enable_ruby
 auto_typecast true
 <record>
  agent ${agent.gsub!(/^\"|\"?$/, '')}
  upstream_addr ${upstream_addr.gsub!(/[^0-9A-Za-z,.:]/, ''); upstream_addr.split(",")}
  upstream_status ${upstream_status.gsub!(/[^0-9A-Za-z,.:]/, ''); upstream_status.split(",")}
  upstream_connect_time ${upstream_connect_time.gsub!(/[^0-9A-Za-z,.:]/, ''); upstream_connect_time.split(",")}
  upstream_response_length ${upstream_response_length.gsub!(/[^0-9A-Za-z,.:]/, ''); upstream_response_length.split(",")}
  upstream_response_time ${upstream_response_time.gsub!(/[^0-9A-Za-z,.:]/, ''); upstream_response_time.split(",")}
  upstream_header_time ${upstream_header_time.gsub!(/[^0-9A-Za-z,.:]/, ''); upstream_header_time.split(",")}
 </record>
</filter>

<match **>
  @type forward
  send_timeout 60s
  recover_wait 10s
  heartbeat_interval 1s
  phi_threshold 16
  hard_timeout 60s

  <server>
    name centralizedfluentd
    host fluentd
    port 24224
  </server>

  <secondary>
    @type file
    path /var/log/fluent/forward-failed
  </secondary>
</match>
